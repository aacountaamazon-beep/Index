<meta name='viewport' content='width=device-width, initial-scale=1'/><!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Dutch (Flemish) Practice Hub - Universal Fix</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            color: #333;
            padding: 20px;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
        }
        
        header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px 30px;
            margin-bottom: 20px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
        }
        
        h1 {
            color: #667eea;
            font-size: 2.5em;
            margin-bottom: 10px;
        }
        
        .subtitle {
            color: #666;
            font-size: 1.1em;
        }
        
        .daily-progress {
            display: flex;
            align-items: center;
            gap: 20px;
            margin-top: 15px;
            padding: 15px;
            background: linear-gradient(90deg, #ff7e5f 0%, #feb47b 100%);
            border-radius: 15px;
            color: white;
            font-weight: bold;
        }
        
        .progress-circle {
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: conic-gradient(white 0deg, rgba(255,255,255,0.3) 360deg);
            display: flex;
            align-items: center;
            justify-content: center;
            position: relative;
        }
        
        .progress-text {
            font-size: 0.9em;
            text-align: center;
        }
        
        .streak {
            margin-left: auto;
            background: rgba(255,255,255,0.2);
            padding: 10px 15px;
            border-radius: 10px;
        }
        
        nav {
            display: flex;
            gap: 10px;
            margin-bottom: 20px;
            flex-wrap: wrap;
        }
        
        .nav-btn {
            padding: 12px 20px;
            background: rgba(255, 255, 255, 0.9);
            border: none;
            border-radius: 15px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
        }
        
        .nav-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }
        
        .nav-btn.active {
            background: #667eea;
            color: white;
        }
        
        .section {
            display: none;
            background: white;
            border-radius: 20px;
            padding: 30px;
            box-shadow: 0 8px 32px rgba(0, 0, 0, 0.1);
            animation: fadeIn 0.5s;
        }
        
        .section.active {
            display: block;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .phrase-card {
            background: white;
            border-radius: 12px;
            padding: 20px;
            margin: 15px 0;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.08);
            transition: transform 0.2s;
            border-left: 5px solid #667eea;
        }
        
        .phrase-card:hover {
            transform: translateY(-3px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.12);
        }
        
        .dutch-text {
            font-size: 1.5em;
            font-weight: bold;
            color: #667eea;
            margin-bottom: 5px;
        }
        
        .pronunciation {
            color: #888;
            font-style: italic;
            margin-bottom: 5px;
            font-family: monospace;
        }
        
        .english-translation {
            color: #555;
            font-size: 1.1em;
            margin-bottom: 8px;
        }
        
        .french-hint {
            color: #ff7e5f;
            font-size: 0.9em;
            font-style: italic;
            margin-bottom: 10px;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            margin-top: 15px;
            flex-wrap: wrap;
        }
        
        button {
            padding: 10px 18px;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 1em;
            transition: all 0.3s;
            display: inline-flex;
            align-items: center;
            gap: 5px;
            font-weight: 500;
        }
        
        .btn-primary {
            background: #667eea;
            color: white;
        }
        
        .btn-secondary {
            background: #ff7e5f;
            color: white;
        }
        
        .btn-success {
            background: #4caf50;
            color: white;
        }
        
        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.2);
        }
        
        button:disabled {
            opacity: 0.6;
            cursor: not-allowed;
            transform: none;
        }
        
        .mic-btn {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            font-size: 2em;
            display: inline-flex;
            align-items: center;
            justify-content: center;
        }
        
        .mic-btn.recording {
            background: #ff4757;
            animation: pulse 1.5s infinite;
        }
        
        @keyframes pulse {
            0% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0.7); }
            70% { box-shadow: 0 0 0 20px rgba(255, 71, 87, 0); }
            100% { box-shadow: 0 0 0 0 rgba(255, 71, 87, 0); }
        }
        
        .feedback {
            margin-top: 15px;
            padding: 15px;
            border-radius: 10px;
            display: none;
            font-weight: 500;
        }
        
        .feedback.success {
            background: #d4edda;
            color: #155724;
            display: block;
            border-left: 4px solid #28a745;
        }
        
        .feedback.error {
            background: #f8d7da;
            color: #721c24;
            display: block;
            border-left: 4px solid #dc3545;
        }
        
        .feedback.processing {
            background: #fff3cd;
            color: #856404;
            display: block;
            border-left: 4px solid #ffc107;
        }
        
        .pronunciation-guide {
            background: #e3f2fd;
            border-radius: 10px;
            padding: 15px;
            margin: 15px 0;
        }
        
        .sound-tip {
            background: white;
            padding: 15px;
            margin: 10px 0;
            border-radius: 8px;
            border-left: 4px solid #2196f3;
            box-shadow: 0 2px 4px rgba(0,0,0,0.05);
        }
        
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }
        
        .stat-card {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px;
            border-radius: 15px;
            text-align: center;
        }
        
        .stat-number {
            font-size: 2.5em;
            font-weight: bold;
            display: block;
        }
        
        .chart-container {
            background: white;
            padding: 20px;
            border-radius: 15px;
            margin-top: 20px;
            height: 300px;
        }
        
        .vocab-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        
        .category-tag {
            display: inline-block;
            background: #667eea;
            color: white;
            padding: 4px 10px;
            border-radius: 12px;
            font-size: 0.8em;
            margin: 3px;
        }
        
        .timer-display {
            font-size: 3em;
            font-weight: bold;
            text-align: center;
            margin: 20px 0;
            color: #667eea;
            font-family: monospace;
        }
        
        .conversation-scenario {
            background: #fff3e0;
            border-radius: 15px;
            padding: 20px;
            margin: 15px 0;
        }
        
        .scenario-title {
            font-size: 1.3em;
            font-weight: bold;
            color: #ff9800;
            margin-bottom: 10px;
        }
        
        .dialogue-line {
            background: white;
            padding: 12px;
            margin: 8px 0;
            border-radius: 10px;
            border-left: 4px solid #ff9800;
        }
        
        .speaker {
            font-weight: bold;
            color: #ff9800;
        }
        
        .debug-info {
            background: #f8f9fa;
            border: 1px solid #dee2e6;
            border-radius: 8px;
            padding: 10px;
            margin: 10px 0;
            font-family: monospace;
            font-size: 0.85em;
            color: #495057;
            display: none;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .debug-info.active {
            display: block;
        }
        
        /* NEW: Permission status indicator */
        .permission-status {
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0,0,0,0.1);
        }
        
        .permission-status.granted {
            background: #d4edda;
            color: #155724;
            border: 1px solid #c3e6cb;
        }
        
        .permission-status.denied {
            background: #f8d7da;
            color: #721c24;
            border: 1px solid #f5c6cb;
        }
        
        .permission-status.unknown {
            background: #fff3cd;
            color: #856404;
            border: 1px solid #ffeaa7;
        }
        
        .permission-status.testing {
            background: #e7f3ff;
            color: #004085;
            border: 1px solid #b8daff;
        }
        
        .test-mic-btn {
            background: #17a2b8;
            color: white;
            margin: 10px 0;
            width: 100%;
        }
        
        .test-mic-btn:hover {
            background: #138496;
        }
        
        .mobile-optimized {
            min-height: 44px; /* Touch target size */
            font-size: 1.1em; /* Better readability on mobile */
        }
        
        @media (max-width: 768px) {
            h1 { font-size: 1.8em; }
            .container { padding: 10px; }
            .section { padding: 20px; }
            .nav-btn { padding: 12px 15px; font-size: 0.9em; min-height: 44px; }
            .mic-btn { width: 90px; height: 90px; font-size: 2.2em; }
            button { min-height: 44px; }
        }
    </style>
</head>
<body>
    <div class="container">
        <header>
            <h1>üáßüá™ Dutch (Flemish) Practice Hub</h1>
            <p class="subtitle">4-Hour Daily Speaking Practice | Universal Fixed Version</p>
            <div class="daily-progress">
                <div class="progress-circle">
                    <div class="progress-text">
                        <span id="hours-display">0</span>h<br>
                        <small>today</small>
                    </div>
                </div>
                <div>
                    <div>Today's Goal: 4 Hours</div>
                    <div id="progress-bar-text">0% Complete</div>
                </div>
                <div class="streak">
                    üî• Streak: <span id="streak-count">0</span> days
                </div>
            </div>
            
            <!-- PERMISSION STATUS INDICATOR -->
            <div id="permission-status" class="permission-status unknown">
                üîç Checking microphone permission...
            </div>
            <button class="test-mic-btn mobile-optimized" onclick="testMicrophone()">
                üé§ Test Microphone Access (Click First!)
            </button>
        </header>

        <nav>
            <button class="nav-btn active mobile-optimized" onclick="showSection('dashboard')">üìä Dashboard</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('phrases')">üí¨ Phrases</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('conversation')">üé≠ Role-Play</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('vocabulary')">üìù Vocabulary</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('pronunciation')">üéØ Pronunciation</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('stats')">üìà Progress</button>
            <button class="nav-btn mobile-optimized" onclick="showSection('settings')">‚öôÔ∏è Settings</button>
        </nav>

        <!-- Dashboard Section -->
        <div id="dashboard" class="section active">
            <h2>Practice Dashboard</h2>
            <div class="timer-display">
                <span id="timer-display">00:00:00</span>
            </div>
            <div style="text-align: center;">
                <button class="mic-btn btn-primary mobile-optimized" id="main-timer-btn" onclick="togglePracticeSession()">
                    <span id="timer-btn-icon">üé§</span>
                </button>
                <p style="margin-top: 10px; color: #666;">Click to start practice session</p>
            </div>
            
            <div class="practice-card">
                <h3>Quick Stats</h3>
                <div class="stats-grid">
                    <div class="stat-card">
                        <span class="stat-number" id="today-phrases">0</span>
                        <span>Phrases Today</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="week-total">0</span>
                        <span>Hours This Week</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="accuracy-rate">0%</span>
                        <span>Accuracy Rate</span>
                    </div>
                    <div class="stat-card">
                        <span class="stat-number" id="vocab-count">0</span>
                        <span>Vocabulary Learned</span>
                    </div>
                </div>
            </div>

            <div class="practice-card">
                <h3>üí° Today's Tip</h3>
                <p id="daily-tip">Flemish Dutch is softer and more melodic than Netherlands Dutch. The 'g' sounds like a gentle 'h' (like in "hello"), not a harsh throat sound!</p>
            </div>
            
            <div class="practice-card">
                <h3>üõ†Ô∏è Troubleshooting</h3>
                <div id="debug-panel" class="debug-info"></div>
                <button class="btn-secondary mobile-optimized" onclick="toggleDebug()">Toggle Debug Info</button>
                <button class="btn-secondary mobile-optimized" onclick="clearDebug()">Clear Logs</button>
            </div>
        </div>

        <!-- Essential Phrases Section -->
        <div id="phrases" class="section">
            <h2>Essential Flemish Phrases</h2>
            <p style="color: #666; margin-bottom: 20px;">
                ‚úÖ <strong>IMPORTANT:</strong> Click "Test Microphone Access" above first!<br>
                Then click any record button and speak clearly.
            </p>
            
            <div id="phrases-container"></div>
        </div>

        <!-- Role-Play Section -->
        <div id="conversation" class="section">
            <h2>Conversation Role-Play Simulator</h2>
            <p style="color: #666; margin-bottom: 20px;">Practice real-life scenarios with interactive dialogues!</p>
            
            <div class="conversation-scenario">
                <div class="scenario-title">Scenario 1: At the Caf√©</div>
                <div class="dialogue-line">
                    <span class="speaker">You:</span> 
                    <span class="dutch-text">Goedendag! Mag ik een koffie en een croissant, alstublieft?</span>
                </div>
                <div class="dialogue-line">
                    <span class="speaker">Waiter:</span> 
                    <span>Uiteraard! Wil je melk en suiker?</span>
                </div>
                <div class="dialogue-line">
                    <span class="speaker">You:</span> 
                    <span class="dutch-text">Ja graag, wat melk maar geen suiker.</span>
                </div>
            </div>

            <div class="conversation-scenario">
                <div class="scenario-title">Scenario 2: Shopping</div>
                <div class="dialogue-line">
                    <span class="speaker">Shop Assistant:</span> 
                    <span>Kan ik u helpen?</span>
                </div>
                <div class="dialogue-line">
                    <span class="speaker">You:</span> 
                    <span class="dutch-text">Ja, ik zoek een nieuwe zetel voor mijn woonkamer.</span>
                    <p style="font-size: 0.9em; color: #666; margin-top: 5px;">üí° Flemish: "zetel" | Netherlands: "bank"</p>
                </div>
            </div>
            
            <div style="text-align: center; margin-top: 20px;">
                <button class="btn-primary mobile-optimized" onclick="practiceScenario()">Practice This Scenario</button>
            </div>
        </div>

        <!-- Vocabulary Section -->
        <div id="vocabulary" class="section">
            <h2>Interactive Vocabulary Builder</h2>
            <div style="margin-bottom: 20px;">
                <button class="btn-primary mobile-optimized" onclick="filterVocab('all')">All</button>
                <button class="btn-secondary mobile-optimized" onclick="filterVocab('food')">üçΩÔ∏è Food</button>
                <button class="btn-secondary mobile-optimized" onclick="filterVocab('home')">üè† Home</button>
                <button class="btn-secondary mobile-optimized" onclick="filterVocab('travel')">‚úàÔ∏è Travel</button>
                <button class="btn-secondary mobile-optimized" onclick="filterVocab('daily')">üìÖ Daily Life</button>
            </div>
            
            <div id="vocabulary-container" class="vocab-grid"></div>
        </div>

        <!-- Pronunciation Section -->
        <div id="pronunciation" class="section">
            <h2>Pronunciation Masterclass</h2>
            <p style="color: #666; margin-bottom: 20px;">Flemish Dutch is softer than Netherlands Dutch. Focus on these key sounds!</p>
            
            <div class="pronunciation-guide">
                <h3>üîë Key Flemish Sounds</h3>
                
                <div class="sound-tip">
                    <strong>The 'G' Sound (Zachte G):</strong> Like English 'h' in "hello"<br>
                    <em>Example: goed (good), dag (day), grote (big)</em><br>
                    <button class="btn-primary mobile-optimized" onclick="playAudio('goed')">‚ñ∂ Listen</button>
                </div>
                
                <div class="sound-tip">
                    <strong>The 'IJ' Sound:</strong> Like English 'ay' in "play"<br>
                    <em>Example: tijd (time), mij (me), wijn (wine)</em><br>
                    <button class="btn-primary mobile-optimized" onclick="playAudio('tijd')">‚ñ∂ Listen</button>
                </div>
            </div>
            
            <h3 style="margin-top: 30px;">üé§ Practice Exercise</h3>
            <div class="practice-card">
                <p>Repeat after the native speaker:</p>
                <div class="dutch-text" id="pronunciation-phrase">Welkom in Vlaanderen!</div>
                <button class="btn-primary mobile-optimized" onclick="playCurrentPhrase()">‚ñ∂ Listen</button>
                <button class="mic-btn btn-secondary mobile-optimized" id="pronunciation-mic" onclick="pronunciationPractice()">
                    üé§
                </button>
                <div id="pronunciation-feedback"></div>
            </div>
        </div>

        <!-- Progress Section -->
        <div id="stats" class="section">
            <h2>Your Progress Analytics</h2>
            
            <div class="stats-grid">
                <div class="stat-card">
                    <span class="stat-number" id="total-hours">0</span>
                    <span>Total Hours</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="best-streak">0</span>
                    <span>Best Streak</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="mastered-phrases">0</span>
                    <span>Phrases Mastered</span>
                </div>
                <div class="stat-card">
                    <span class="stat-number" id="weekly-goal">0%</span>
                    <span>Weekly Goal</span>
                </div>
            </div>
            
            <div class="chart-container">
                <h3>Daily Practice Hours (Last 7 Days)</h3>
                <canvas id="progress-chart"></canvas>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings" class="section">
            <h2>Settings & Preferences</h2>
            
            <div class="practice-card">
                <h3>Dutch Variant</h3>
                <label>
                    <input type="radio" name="dutch-variant" value="nl-BE" checked> 
                    Flemish (Belgium) - Softer, more melodic
                </label><br>
                <label>
                    <input type="radio" name="dutch-variant" value="nl-NL"> 
                    Netherlands Dutch - Standard
                </label>
            </div>
            
            <div class="practice-card">
                <h3>Speech Recognition Confidence</h3>
                <label>
                    Sensitivity: 
                    <input type="range" id="confidence-threshold" min="0.3" max="0.9" step="0.1" value="0.6">
                    <span id="confidence-display">60%</span>
                </label>
                <p style="font-size: 0.9em; color: #666;">Lower = more lenient, Higher = stricter</p>
            </div>
            
            <div class="practice-card">
                <h3>Debug Mode</h3>
                <label>
                    <input type="checkbox" id="debug-mode" checked> 
                    Show debug information
                </label>
            </div>
        </div>
    </div>

    <script>
        // GLOBAL SINGLETON - THE KEY FIX
        let recognition = null;
        let practiceStartTime = null;
        let practiceInterval = null;
        let currentDutchVariant = 'nl-BE';
        let showFrenchHints = true;
        let currentPhraseIndex = 0;
        let isRecording = false;
        let debugMode = true;
        let confidenceThreshold = 0.6;
        let micPermissionGranted = false;
        let isTesting = false;

        // Data for phrases and vocabulary
        const phrases = [
            { dutch: 'Goedemorgen!', pron: 'KHOO-duh-MOR-khen', eng: 'Good morning!', fr: 'Bonjour !', cat: 'greetings' },
            { dutch: 'Dank u wel', pron: 'dank yoo vel', eng: 'Thank you very much (formal)', fr: 'Merci beaucoup', cat: 'greetings' },
            { dutch: 'Alstublieft', pron: 'ALST-yoo-bleeft', eng: 'Please / Here you go', fr: 'S\'il vous pla√Æt / Voil√†', cat: 'polite' },
            { dutch: 'Pardon, spreekt u Engels?', pron: 'par-DON, SPRAYKT yoo ENG-els?', eng: 'Excuse me, do you speak English?', fr: 'Pardon, parlez-vous anglais ?', cat: 'conversation' },
            { dutch: 'Ik begrijp het niet', pron: 'ik buh-GRAYP uht neet', eng: 'I don\'t understand', fr: 'Je ne comprends pas', cat: 'conversation' },
            { dutch: 'Kunt u dat herhalen?', pron: 'kunt yoo daht HER-haa-len?', eng: 'Could you repeat that?', fr: 'Pourriez-vous r√©p√©ter ?', cat: 'conversation' },
            { dutch: 'Waar is het toilet?', pron: 'vaar uhs uht twa-LET?', eng: 'Where is the bathroom?', fr: 'O√π sont les toilettes ?', cat: 'directions' },
            { dutch: 'Ik heb honger', pron: 'ik hep HONG-er', eng: 'I\'m hungry', fr: 'J\'ai faim', cat: 'daily' },
            { dutch: 'De rekening, alstublieft', pron: 'duh REK-uh-ning, ALST-yoo-bleeft', eng: 'The bill, please', fr: 'L\'addition, s\'il vous pla√Æt', cat: 'restaurant' },
            { dutch: 'Tot ziens', pron: 'tot zeens', eng: 'Goodbye', fr: 'Au revoir', cat: 'greetings' },
            { dutch: 'Goeiedag!', pron: 'KHOO-ee-dukh', eng: 'Hello! (Flemish)', fr: 'Bonjour !', cat: 'greetings' },
            { dutch: 'Goesting?', pron: 'KHOOS-ting?', eng: 'Fancy something? (Flemish)', fr: 'Envie de quelque chose ?', cat: 'flemish' },
            { dutch: 'Zetel', pron: 'ZET-el', eng: 'Sofa (Flemish)', fr: 'Canap√©', cat: 'flemish' },
            { dutch: 'Frigo', pron: 'FREE-go', eng: 'Fridge (Flemish)', fr: 'R√©frig√©rateur', cat: 'flemish' },
            { dutch: 'Ik woon in Belgi√´', pron: 'ik vohn in BEL-juh', eng: 'I live in Belgium', fr: 'J\'habite en Belgique', cat: 'intro' },
        ];

        const vocabulary = [
            { dutch: 'het huis', eng: 'house', fr: 'la maison', cat: 'home' },
            { dutch: 'de zetel', eng: 'sofa', fr: 'le canap√©', cat: 'home' },
            { dutch: 'de koelkast', eng: 'refrigerator', fr: 'le r√©frig√©rateur', cat: 'home' },
            { dutch: 'het brood', eng: 'bread', fr: 'le pain', cat: 'food' },
            { dutch: 'de appelsien', eng: 'orange', fr: 'l\'orange', cat: 'food' },
            { dutch: 'de boter', eng: 'butter', fr: 'le beurre', cat: 'food' },
            { dutch: 'het water', eng: 'water', fr: 'l\'eau', cat: 'daily' },
            { dutch: 'de trein', eng: 'train', fr: 'le train', cat: 'travel' },
            { dutch: 'het station', eng: 'station', fr: 'la gare', cat: 'travel' },
            { dutch: 'de parking', eng: 'parking lot', fr: 'le parking', cat: 'flemish' },
            { dutch: 'goesting', eng: 'appetite/desire', fr: 'l\'envie', cat: 'flemish' },
            { dutch: 'kuisen', eng: 'to clean', fr: 'nettoyer', cat: 'daily' },
        ];

        // REUSABLE SINGLETON - THE CRITICAL FIX
        function getSpeechRecognition() {
            if (recognition) return recognition;
            
            const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
            if (!SpeechRecognitionAPI) {
                showDebug('ERROR: Speech Recognition API not supported');
                return null;
            }
            
            recognition = new SpeechRecognitionAPI();
            recognition.continuous = false;
            recognition.interimResults = false;
            recognition.lang = currentDutchVariant;
            
            return recognition;
        }

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            initializeSpeechRecognition();
            loadPhrases();
            loadVocabulary();
            updateStats();
            loadDailyTip();
            checkMicrophonePermission();
            
            // Settings listeners
            document.querySelectorAll('input[name="dutch-variant"]').forEach(radio => {
                radio.addEventListener('change', (e) => {
                    currentDutchVariant = e.target.value;
                    localStorage.setItem('dutchVariant', currentDutchVariant);
                    if (recognition) {
                        recognition.lang = currentDutchVariant;
                    }
                    showDebug(`Language changed to: ${currentDutchVariant}`);
                });
            });
            
            document.getElementById('confidence-threshold').addEventListener('input', (e) => {
                confidenceThreshold = parseFloat(e.target.value);
                document.getElementById('confidence-display').textContent = `${Math.round(confidenceThreshold * 100)}%`;
                showDebug(`Confidence threshold: ${confidenceThreshold}`);
            });
            
            document.getElementById('debug-mode').addEventListener('change', (e) => {
                debugMode = e.target.checked;
                document.getElementById('debug-panel').classList.toggle('active', debugMode);
            });
        });

        // Navigation
        function showSection(sectionId) {
            document.querySelectorAll('.section').forEach(s => s.classList.remove('active'));
            document.querySelectorAll('.nav-btn').forEach(b => b.classList.remove('active'));
            
            document.getElementById(sectionId).classList.add('active');
            event.target.classList.add('active');
        }

        // PERMISSION MANAGEMENT - THE KEY FIX FOR MOBILE
        async function checkMicrophonePermission() {
            try {
                // Check for HTTPS requirement (critical for mobile)
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    updatePermissionStatus('denied', 
                        '‚ùå HTTPS Required: Please host on a secure server or use localhost for speech recognition to work.');
                    showDebug('ERROR: Not on HTTPS or localhost');
                    return;
                }
                
                // Check browser support
                const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognitionAPI) {
                    updatePermissionStatus('denied', 
                        '‚ùå Speech Recognition not supported in this browser. Use Chrome/Samsung Internet.');
                    showDebug('ERROR: Speech Recognition API not available');
                    return;
                }
                
                // Test language support
                const testRecognition = new SpeechRecognitionAPI();
                if (!testRecognition) {
                    updatePermissionStatus('denied', '‚ùå Failed to initialize speech recognition');
                    return;
                }
                
                // Check permissions API
                if (navigator.permissions && navigator.permissions.query) {
                    const result = await navigator.permissions.query({ name: 'microphone' });
                    if (result.state === 'granted') {
                        micPermissionGranted = true;
                        updatePermissionStatus('granted', '‚úÖ Microphone ready! Click any record button to practice.');
                        showDebug('Permission already granted');
                    } else if (result.state === 'prompt') {
                        updatePermissionStatus('unknown', '‚ö†Ô∏è Click "Test Microphone Access" to grant permission');
                        showDebug('Permission not yet requested');
                    } else {
                        updatePermissionStatus('denied', '‚ùå Permission denied. Please enable in browser settings and refresh.');
                        showDebug('Permission denied');
                    }
                } else {
                    // Fallback for browsers without permissions API
                    updatePermissionStatus('unknown', '‚ö†Ô∏è Click "Test Microphone Access" to check permission');
                }
            } catch (error) {
                showDebug(`Permission check error: ${error.message}`);
                updatePermissionStatus('unknown', '‚ö†Ô∏è Unable to check status. Click test button.');
            }
        }

        async function testMicrophone() {
            if (isTesting) return;
            
            isTesting = true;
            const btn = event.target;
            btn.textContent = 'üîç Testing Microphone...';
            btn.disabled = true;
            
            try {
                // Test 1: Check HTTPS
                if (window.location.protocol !== 'https:' && window.location.hostname !== 'localhost') {
                    throw new Error('HTTPS_REQUIRED');
                }
                
                // Test 2: Get microphone access
                showDebug('Requesting microphone stream...');
                const stream = await navigator.mediaDevices.getUserMedia({ audio: true });
                showDebug('‚úÖ Microphone access granted');
                
                // Test 3: Check SpeechRecognition support
                const SpeechRecognitionAPI = window.SpeechRecognition || window.webkitSpeechRecognition;
                if (!SpeechRecognitionAPI) {
                    throw new Error('API_NOT_SUPPORTED');
                }
                
                // Test 4: Test speech recognition (briefly)
                const testRecognition = new SpeechRecognitionAPI();
                testRecognition.lang = currentDutchVariant;
                testRecognition.continuous = false;
                
                return new Promise((resolve) => {
                    let testCompleted = false;
                    
                    testRecognition.onstart = () => {
                        showDebug('‚úÖ Speech recognition initialized');
                        updatePermissionStatus('testing', 'üîç Testing speech recognition... Speak if you want!');
                        
                        // Stop after 2 seconds
                        setTimeout(() => {
                            if (!testCompleted) {
                                testRecognition.stop();
                                stream.getTracks().forEach(track => track.stop());
                            }
                        }, 2000);
                    };
                    
                    testRecognition.onresult = (event) => {
                        testCompleted = true;
                        showDebug(`‚úÖ Heard: "${event.results[0][0].transcript}"`);
                        updatePermissionStatus('granted', 
                            '‚úÖ All systems working! You can now practice speech recognition.');
                        micPermissionGranted = true;
                        resolve();
                    };
                    
                    testRecognition.onerror = (event) => {
                        testCompleted = true;
                        showDebug(`Test recognition error: ${event.error}`);
                        
                        // Many mobile browsers error but still work
                        if (event.error === 'no-speech' || event.error === 'aborted') {
                            updatePermissionStatus('granted', 
                                '‚úÖ Microphone working! (No speech detected in test, but ready to use)');
                            micPermissionGranted = true;
                        } else if (event.error === 'language-not-supported') {
                            updatePermissionStatus('denied', 
                                `‚ùå Language "${currentDutchVariant}" not supported on this device. Try nl-NL in settings.`);
                        } else {
                            updatePermissionStatus('denied', 
                                `‚ùå Speech recognition error: ${event.error}`);
                        }
                        resolve();
                    };
                    
                    testRecognition.onend = () => {
                        if (!testCompleted) {
                            testCompleted = true;
                            updatePermissionStatus('granted', 
                                '‚úÖ Test complete! System is ready.');
                            micPermissionGranted = true;
                            resolve();
                        }
                        stream.getTracks().forEach(track => track.stop());
                    };
                    
                    // Start the test
                    testRecognition.start();
                });
                
            } catch (err) {
                handleMicrophoneError(err);
            } finally {
                btn.textContent = 'üé§ Test Microphone Access';
                btn.disabled = false;
                isTesting = false;
            }
        }

        function handleMicrophoneError(error) {
            let errorMessage = '‚ùå Microphone error: ';
            switch(error.name || error.message) {
                case 'HTTPS_REQUIRED':
                    errorMessage += 'HTTPS or localhost required. Host on a secure server.';
                    break;
                case 'API_NOT_SUPPORTED':
                    errorMessage += 'Speech API not supported. Use Chrome/Samsung Internet.';
                    break;
                case 'NotAllowedError':
                case 'PermissionDismissedError':
                    errorMessage += 'Permission denied. Please allow access and refresh.';
                    break;
                case 'NotFoundError':
                    errorMessage += 'No microphone found.';
                    break;
                case 'language-not-supported':
                    errorMessage += `Language not supported. Try "nl-NL" instead.`;
                    break;
                default:
                    errorMessage += `${error.message || error}`;
            }
            updatePermissionStatus('denied', errorMessage);
            showDebug(`Error: ${errorMessage}`);
        }

        function updatePermissionStatus(status, message) {
            const statusEl = document.getElementById('permission-status');
            statusEl.className = `permission-status ${status}`;
            statusEl.textContent = message;
        }

        // FIXED: Single reusable record function
        function recordPhrase(index) {
            if (isTesting) {
                alert('Please wait for microphone test to complete');
                return;
            }
            
            if (!micPermissionGranted) {
                alert('<strong>IMPORTANT:</strong> Click "Test Microphone Access" first to grant permission!');
                return;
            }
            
            if (isRecording) {
                showDebug('Already recording, please wait...');
                return;
            }
            
            const feedbackEl = document.getElementById(`feedback-${index}`);
            const recordBtn = document.querySelectorAll('.mic-record-btn')[index];
            
            // Get SINGLETON recognition instance
            const recognition = getSpeechRecognition();
            if (!recognition) {
                feedbackEl.className = 'feedback error';
                feedbackEl.textContent = '‚ùå Speech recognition not supported';
                feedbackEl.style.display = 'block';
                return;
            }
            
            // Configure recognition (reuse same instance)
            recognition.lang = currentDutchVariant;
            recognition.interimResults = false;
            recognition.continuous = false;
            
            // SINGLETON event handlers - defined ONCE
            recognition.onstart = () => {
                isRecording = true;
                updateMicButtons();
                feedbackEl.className = 'feedback processing';
                feedbackEl.innerHTML = 'üéôÔ∏è <strong>Listening...</strong><br>Speak the phrase clearly...';
                feedbackEl.style.display = 'block';
                showDebug(`START: Recognizing phrase #${index}: "${phrases[index].dutch}"`);
            };
            
            recognition.onresult = (event) => {
                const transcript = event.results[0][0].transcript;
                const confidence = event.results[0][0].confidence;
                
                showDebug(`RESULT: "${transcript}" (${(confidence*100).toFixed(1)}% confidence)`);
                
                // Compare with fuzzy matching
                const expected = normalizeText(phrases[index].dutch);
                const actual = normalizeText(transcript);
                const similarity = calculateSimilarity(actual, expected);
                
                if (confidence >= confidenceThreshold && similarity > 0.6) {
                    feedbackEl.className = 'feedback success';
                    feedbackEl.innerHTML = `
                        ‚úÖ <strong>Excellent!</strong><br>
                        You said: "${transcript}"<br>
                        <small>Confidence: ${(confidence * 100).toFixed(1)}%</small>
                    `;
                    
                    // Update stats
                    let todayStats = JSON.parse(localStorage.getItem('todayStats') || '{"phrases":0}');
                    todayStats.phrases++;
                    localStorage.setItem('todayStats', JSON.stringify(todayStats));
                    updateStats();
                    
                    setTimeout(() => feedbackEl.style.display = 'none', 3000);
                } else {
                    feedbackEl.className = 'feedback error';
                    feedbackEl.innerHTML = `
                        ‚ùå <strong>Not quite right</strong><br>
                        You said: "${transcript}"<br>
                        <small>Confidence: ${(confidence * 100).toFixed(1)}% (need ${Math.round(confidenceThreshold * 100)}%)</small><br>
                        <small>Try speaking slower and clearer</small>
                    `;
                }
            };
            
            recognition.onerror = (event) => {
                showDebug(`ERROR: ${event.error}`);
                let errorMsg = '‚ùå <strong>Error:</strong> ';
                
                switch(event.error) {
                    case 'no-speech':
                        errorMsg += 'No speech detected. Speak louder and clearer.';
                        break;
                    case 'audio-capture':
                        errorMsg += 'Microphone not accessible. Check permissions.';
                        break;
                    case 'not-allowed':
                        errorMsg += 'Permission denied. Enable in browser settings.';
                        break;
                    case 'language-not-supported':
                        errorMsg += `Language "${currentDutchVariant}" not supported. Try nl-NL.`;
                        break;
                    case 'network':
                        errorMsg += 'Network error. Check connection.';
                        break;
                    default:
                        errorMsg += event.error;
                }
                
                feedbackEl.className = 'feedback error';
                feedbackEl.innerHTML = errorMsg;
            };
            
            recognition.onend = () => {
                isRecording = false;
                updateMicButtons();
                showDebug('END: Recognition session ended');
                
                // Auto-hide error after 5 seconds
                if (feedbackEl.className.includes('error')) {
                    setTimeout(() => feedbackEl.style.display = 'none', 5000);
                }
            };
            
            // Start recognition with mobile optimization
            try {
                // Stop any ongoing speech synthesis
                if (speechSynthesis.speaking) {
                    speechSynthesis.cancel();
                }
                
                recognition.start();
                showDebug('Recognition started successfully');
            } catch (e) {
                showDebug(`Failed to start: ${e.message}`);
                feedbackEl.className = 'feedback error';
                feedbackEl.textContent = '‚ùå Failed to start. Try refreshing the page.';
                isRecording = false;
                updateMicButtons();
            }
        }

        // ... (rest of functions remain the same but with improvements) ...
        
        // Text normalization for comparison
        function normalizeText(text) {
            return text.toLowerCase()
                .replace(/[.,!?]/g, '')
                .replace(/^\s+|\s+$/g, '')
                .replace(/\s+/g, ' ');
        }

        // Calculate similarity between strings
        function calculateSimilarity(str1, str2) {
            const longer = str1.length > str2.length ? str1 : str2;
            const shorter = str1.length > str2.length ? str2 : str1;
            if (longer.length === 0) return 1.0;
            
            const editDistance = levenshteinDistance(longer, shorter);
            return (longer.length - editDistance) / longer.length;
        }

        function levenshteinDistance(str1, str2) {
            const matrix = [];
            for (let i = 0; i <= str2.length; i++) matrix[i] = [i];
            for (let j = 0; j <= str1.length; j++) matrix[0][j] = j;
            
            for (let i = 1; i <= str2.length; i++) {
                for (let j = 1; j <= str1.length; j++) {
                    if (str2.charAt(i - 1) === str1.charAt(j - 1)) {
                        matrix[i][j] = matrix[i - 1][j - 1];
                    } else {
                        matrix[i][j] = Math.min(
                            matrix[i - 1][j - 1] + 1,
                            matrix[i][j - 1] + 1,
                            matrix[i - 1][j] + 1
                        );
                    }
                }
            }
            return matrix[str2.length][str1.length];
        }

        // ... (other functions: loadVocabulary, filterVocab, playAudio, etc.) ...
        
        function loadVocabulary() {
            const container = document.getElementById('vocabulary-container');
            container.innerHTML = '';
            
            vocabulary.forEach((word, index) => {
                const card = document.createElement('div');
                card.className = 'phrase-card';
                card.dataset.category = word.cat;
                card.innerHTML = `
                    <div class="dutch-text">${word.dutch}</div>
                    <div class="english-translation">${word.eng}</div>
                    ${showFrenchHints && word.fr ? `<div class="french-hint">üá´üá∑ ${word.fr}</div>` : ''}
                    <span class="category-tag">${word.cat}</span>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="btn-primary mobile-optimized" onclick="playAudio('${word.dutch}')">‚ñ∂ Listen</button>
                    </div>
                `;
                container.appendChild(card);
            });
        }

        function playAudio(text) {
            if ('speechSynthesis' in window) {
                speechSynthesis.cancel();
                const utterance = new SpeechSynthesisUtterance(text);
                utterance.lang = currentDutchVariant;
                utterance.rate = 0.8;
                utterance.pitch = 1.1;
                utterance.volume = 1;
                speechSynthesis.speak(utterance);
                showDebug(`Speaking: "${text}" in ${currentDutchVariant}`);
            } else {
                alert('Speech synthesis not supported');
            }
        }

        function updateMicButtons() {
            const buttons = document.querySelectorAll('.mic-record-btn, #pronunciation-mic, #main-timer-btn');
            buttons.forEach(btn => {
                if (isRecording) {
                    btn.classList.add('recording');
                    btn.disabled = true;
                } else {
                    btn.classList.remove('recording');
                    btn.disabled = false;
                }
            });
        }

        // Debug functions
        function showDebug(message) {
            if (!debugMode) return;
            const debugPanel = document.getElementById('debug-panel');
            const timestamp = new Date().toLocaleTimeString('en-US', {hour12: false});
            debugPanel.innerHTML += `[${timestamp}] ${message}<br>`;
            debugPanel.scrollTop = debugPanel.scrollHeight;
            console.log(`[Dutch App] ${message}`);
        }

        function clearDebug() {
            document.getElementById('debug-panel').innerHTML = '';
        }

        function toggleDebug() {
            debugMode = !debugMode;
            document.getElementById('debug-panel').classList.toggle('active', debugMode);
            showDebug(`Debug mode: ${debugMode ? 'ON' : 'OFF'}`);
        }

        // Timer functions (simplified for brevity)
        function togglePracticeSession() {
            const btn = document.getElementById('main-timer-btn');
            const icon = document.getElementById('timer-btn-icon');
            
            if (!practiceStartTime) {
                practiceStartTime = Date.now();
                btn.classList.add('recording');
                icon.textContent = '‚èπÔ∏è';
                startPracticeInterval();
                
                let todayStats = JSON.parse(localStorage.getItem('todayStats') || '{"phrases":0,"sessions":0}');
                todayStats.sessions++;
                localStorage.setItem('todayStats', JSON.stringify(todayStats));
            } else {
                endPracticeSession();
            }
        }

        function startPracticeInterval() {
            practiceInterval = setInterval(() => {
                const elapsed = Date.now() - practiceStartTime;
                const hours = Math.floor(elapsed / 3600000);
                const minutes = Math.floor((elapsed % 3600000) / 60000);
                const seconds = Math.floor((elapsed % 60000) / 1000);
                
                document.getElementById('timer-display').textContent = 
                    `${hours.toString().padStart(2, '0')}:${minutes.toString().padStart(2, '0')}:${seconds.toString().padStart(2, '0')}`;
                
                updateDailyProgress(hours + (minutes / 60) + (seconds / 3600));
            }, 1000);
        }

        function endPracticeSession() {
            const btn = document.getElementById('main-timer-btn');
            const icon = document.getElementById('timer-btn-icon');
            const elapsed = Date.now() - practiceStartTime;
            
            btn.classList.remove('recording');
            icon.textContent = 'üé§';
            clearInterval(practiceInterval);
            practiceStartTime = null;
            
            const hoursPracticed = elapsed / 3600000;
            savePracticeTime(hoursPracticed);
        }

        function updateDailyProgress(hours) {
            document.getElementById('hours-display').textContent = hours.toFixed(1);
            const percentage = Math.min((hours / 4) * 100, 100);
            document.getElementById('progress-bar-text').textContent = `${Math.round(percentage)}% Complete`;
        }

        function savePracticeTime(hours) {
            const today = new Date().toDateString();
            let stats = JSON.parse(localStorage.getItem('practiceStats') || '{}');
            let userData = JSON.parse(localStorage.getItem('userData') || '{"streak":0,"bestStreak":0}');
            
            if (!stats[today]) stats[today] = 0;
            stats[today] += hours;
            
            const yesterday = new Date(Date.now() - 86400000).toDateString();
            if (stats[yesterday] >= 4 || userData.lastPracticeDate === yesterday) {
                userData.streak++;
            } else if (stats[today] >= 4) {
                userData.streak = 1;
            }
            
            userData.bestStreak = Math.max(userData.bestStreak, userData.streak);
            userData.lastPracticeDate = today;
            
            localStorage.setItem('practiceStats', JSON.stringify(stats));
            localStorage.setItem('userData', JSON.stringify(userData));
            updateStats();
        }

        function updateStats() {
            const stats = JSON.parse(localStorage.getItem('practiceStats') || '{}');
            const userData = JSON.parse(localStorage.getItem('userData') || '{"streak":0,"bestStreak":0}');
            const todayStats = JSON.parse(localStorage.getItem('todayStats') || '{"phrases":0}');
            
            const totalHours = Object.values(stats).reduce((a, b) => a + b, 0);
            const weekDays = [];
            for (let i = 0; i < 7; i++) {
                const date = new Date(Date.now() - i * 86400000).toDateString();
                weekDays.push(stats[date] || 0);
            }
            const weekTotal = weekDays.reduce((a, b) => a + b, 0);
            
            document.getElementById('streak-count').textContent = userData.streak;
            document.getElementById('today-phrases').textContent = todayStats.phrases;
            document.getElementById('week-total').textContent = weekTotal.toFixed(1);
            document.getElementById('vocab-count').textContent = vocabulary.length;
            document.getElementById('total-hours').textContent = totalHours.toFixed(1);
            document.getElementById('best-streak').textContent = userData.bestStreak;
            document.getElementById('weekly-goal').textContent = `${Math.round((weekTotal / 28) * 100)}%`;
        }

        function loadDailyTip() {
            const tips = [
                "Flemish Dutch is softer and more melodic than Netherlands Dutch. The 'g' sounds like a gentle 'h' (like in \"hello\"), not a harsh throat sound!",
                "In Flanders, people use 'goesting' (desire) instead of Netherlands' 'zin'. Example: 'Heb je goesting?' = 'Do you feel like it?'",
                "Flemish speakers often use diminutives (-je, -tje) for politeness. Try 'een koffietje' instead of just 'koffie'!",
                "The formal 'u' is more common in Belgium than in the Netherlands. Use it with strangers and in shops!",
                "Flemish 'r' is rolled with the tip of your tongue, like in Spanish or Italian. Practice makes perfect!"
            ];
            const randomTip = tips[Math.floor(Math.random() * tips.length)];
            document.getElementById('daily-tip').textContent = randomTip;
        }

        // Utility functions
        function practiceScenario() {
            alert('Practice mode activated! Click any record button in Phrases section to practice.');
            showSection('phrases');
        }

        // Save before unload
        window.addEventListener('beforeunload', () => {
            if (practiceStartTime) endPracticeSession();
            if (recognition && isRecording) recognition.stop();
        });
    </script>
</body>
</html>
